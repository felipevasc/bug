#!/usr/bin/env bash
set -euo pipefail

# @skill: shell/exploit/sqli-test
# @inputs: target[, out-dir, scope-file, rate, timeout, allow-exploit]
# @outputs: finding|note
# @tools: sqlmap, curl

TARGET=""
OUT_DIR=""
SCOPE_FILE=""
RATE=""
TIMEOUT=""
ALLOW_EXPLOIT="false"
URL=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    --target)
      TARGET="${2:-}"
      shift 2
      ;;
    --out-dir)
      OUT_DIR="${2:-}"
      shift 2
      ;;
    --scope-file)
      SCOPE_FILE="${2:-}"
      shift 2
      ;;
    --rate)
      RATE="${2:-}"
      shift 2
      ;;
    --timeout)
      TIMEOUT="${2:-}"
      shift 2
      ;;
    --allow-exploit)
      ALLOW_EXPLOIT="true"
      shift
      ;;
    --url)
      URL="${2:-}"
      shift 2
      ;;
    *)
      if [[ -z "$TARGET" ]]; then
        TARGET="$1"
      fi
      shift
      ;;
  esac
done

if [[ -z "$TARGET" ]]; then
  echo "Usage: $0 --target <target> (or positional <target>)" >&2
  exit 1
fi

TS="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
RUN_TS="${RUN_TS:-}"
if [[ -z "$RUN_TS" ]]; then RUN_TS="$(date -u +%Y%m%dT%H%M%SZ)"; fi
ROOT_OUT="${OUT_DIR:-}"
if [[ -z "$ROOT_OUT" ]]; then ROOT_OUT="data/runs/${RUN_TS}"; fi
EV_DIR="${ROOT_OUT}/evidence/exploit/sqli"
mkdir -p "$EV_DIR"
TIMEOUT="${TIMEOUT:-60}"

emit_note() {
  local tool="$1"; shift
  local sev="$1"; shift
  local msg="$1"; shift
  printf '{"type":"note","tool":"%s","stage":"exploit","target":"%s","ts":"%s","severity":"%s","evidence":%s,"data":{"message":"%s"},"source":"src/skills/shell/exploit/01-sqli-test.sh"}\n' \
    "$tool" "$TARGET" "$TS" "$sev" "[]" "$(printf '%s' "$msg" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read().strip())[1:-1])')"
}

in_scope() {
  local host="$1"
  [[ -z "$SCOPE_FILE" ]] && return 0
  [[ ! -f "$SCOPE_FILE" ]] && return 0
  local ok="0"
  while IFS= read -r line; do
    line="${line%%#*}"; line="$(echo "$line" | xargs)"
    [[ -z "$line" ]] && continue
    if [[ "$line" == "*."* ]]; then
      local root="${line#*.}"
      if [[ "$host" == "$root" || "$host" == *".${root}" ]]; then ok="1"; break; fi
    else
      if [[ "$host" == "$line" || "$host" == *".${line}" ]]; then ok="1"; break; fi
    fi
  done < "$SCOPE_FILE"
  [[ "$ok" == "1" ]]
}

if ! in_scope "$TARGET"; then
  emit_note "scope" "info" "target not in scope (blocked)"
  exit 0
fi

# Safe-by-default: no active SQLi probing.
if [[ "$ALLOW_EXPLOIT" != "true" || "${CONFIRM:-}" != "arrocha!" ]]; then
  emit_note "exploit-gate" "info" "intrusive actions blocked; require --allow-exploit and env CONFIRM=arrocha!"
  exit 0
fi

if [[ -z "$URL" ]]; then
  emit_note "sqli-test" "info" "no --url provided; skipping sqlmap"
  exit 0
fi

if ! command -v sqlmap >/dev/null 2>&1; then
  emit_note "sqlmap" "info" "tool not found; skipping"
  exit 0
fi

out_txt="${EV_DIR}/sqlmap.$(echo -n "$URL" | python3 -c 'import base64,sys; print(base64.urlsafe_b64encode(sys.stdin.buffer.read()).decode().rstrip(\"=\"))').txt"
timeout "${TIMEOUT}s" sqlmap -u "$URL" --batch --level 1 --risk 1 --timeout 10 --retries 0 --threads 1 --random-agent --output-dir="$EV_DIR/sqlmap-out" >"$out_txt" 2>&1 || true

printf '{"type":"finding","tool":"sqlmap","stage":"exploit","target":"%s","ts":"%s","severity":"med","evidence":["%s"],"data":{"url":"%s","message":"sqlmap run completed (review evidence)"},"source":"src/skills/shell/exploit/01-sqli-test.sh"}\n' \
  "$TARGET" "$TS" "$out_txt" "$URL"
